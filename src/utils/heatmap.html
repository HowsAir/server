
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat"></script>
    <script src="../libs/leaflet_plugins/leaflet-idw.js"></script>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        .leaflet-control-layers .disabled {
            pointer-events: none;
            opacity: 0.5;
        }
        .legend {
            position: absolute;
            bottom: 30px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            line-height: 1.5em;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        .legend-title {
            font-weight: bold;
        }
        .legend-item {
            display: flex;
            align-items: center;
        }
        .legend-item .color-box {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        const map = L.map('map').setView([39.4699, -0.3763], 15);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/">CARTO</a>',
            subdomains: 'abcd',
            minZoom: 14,
            maxZoom: 19
        }).addTo(map);

        const idwLayer = L.idwLayer(
            [[39.454704098338105, -0.3632310633795214, 0.3],[39.45801734069818, -0.36941883807711656, 0.6],[39.49077133000704, -0.36166787126203886, 0.3],[39.46423900967008, -0.37625754830051183, 1],[39.475903059604335, -0.3981201960273996, 1],[39.48019357457446, -0.3597977283223486, 1],[39.4925725151271, -0.3690378149175719, 0.3],[39.466039597830736, -0.35723037108371875, 1],[39.493643987845985, -0.37103883421468886, 1],[39.4631025388491, -0.3967195685371127, 1],[39.47150883829474, -0.3773527077861815, 0.6],[39.48290796697344, -0.35884418671779095, 1],[39.4741361410488, -0.37240779364966264, 0.6],[39.46773629776534, -0.3521299497965166, 1],[39.48600615759056, -0.37722706300146636, 0.6],[39.480200139979054, -0.3758253317714486, 1],[39.46028857648889, -0.38745357433295174, 1],[39.45464056597032, -0.38011938332733264, 0.6],[39.461610128146454, -0.36776091408763667, 0.6],[39.48044511075696, -0.37125835264309504, 0.6],[39.45140558553518, -0.3761747739353963, 1],[39.4813098571244, -0.3870275433282067, 1],[39.48762241304064, -0.35756157978323794, 1],[39.47245761150213, -0.3718823180829722, 0.6],[39.48660513477169, -0.39919547537618666, 0.6],[39.4845679970202, -0.38815701943917114, 0.6],[39.48361598878671, -0.3879855071489995, 0.3],[39.47619222126366, -0.3997747540249506, 0.6],[39.478860331196486, -0.3843590397093646, 0.6],[39.46220265117789, -0.35793908700074123, 0.3],[39.480925798453576, -0.35150441212867356, 0.3],[39.45820131143572, -0.35605591416407467, 1],[39.455189802276365, -0.3888050692890648, 0.6],[39.49390532559298, -0.39419699041252, 1],[39.47620409836753, -0.36160695144327953, 0.6],[39.489484591029914, -0.3777122030126461, 0.3],[39.49474460321886, -0.3899936644460752, 0.6],[39.44664517583989, -0.3636295449548456, 0.6],[39.48823839476442, -0.3730487928820815, 0.6],[39.45360843590089, -0.39004467117377456, 0.6],[39.4848559139539, -0.3809518117891388, 0.3],[39.4569295846187, -0.3778287360674151, 1],[39.483071063230064, -0.4008915627062858, 0.3],[39.44627360838937, -0.394679314482826, 0.6],[39.47658458438568, -0.3970576633255426, 1],[39.45531728623225, -0.3970848442508582, 1],[39.45272228055146, -0.3735504786525932, 0.3],[39.476861871993506, -0.3541421459376313, 0.6],[39.46940626544879, -0.35490114094716835, 0.3],[39.44937282064006, -0.3908054999955857, 1]], // Normalizar intensidad entre 0 y 1
            {
                opacity: 0.4,          // Ajustar opacidad
                cellSize: 6,          // Tamaño de celda (ajusta según detalle)
                exp: 2,                // Exponente para ponderación (2 es estándar para IDW)
                max: 1,                // Máximo valor (intensidad normalizada)
                gradient: {            // Gradiente de colores
                    0.3: 'green',
                    0.6: 'yellow',
                    1.0: 'red'
                }
            }
        );

        map.on('zoomend', updateCellSize);

        function updateCellSize() {
            const zoom = map.getZoom();
            let newCellSize;

            if (zoom < 16) {
                newCellSize = 6;
            } else if (zoom >= 16 && zoom < 18) {
                newCellSize = 10; 
            } else if (zoom >= 18) {
                newCellSize = 25; // Ajuste de tamaño de celda a medida que el zoom es más alto
            }

            // Actualiza las opciones del layer de IDW con el nuevo tamaño de celda
            idwLayer.setOptions({ cellSize: newCellSize });
            idwLayer.redraw();
        }

        idwLayer.addTo(map);

        // Capa de estaciones oficiales (nuevo)
        const estacionesOficiales = L.layerGroup();

        // Fetching todas las estaciones de calidad del aire en Valencia
        fetch('https://api.waqi.info/map/bounds/?latlng=39.4,-0.6,39.6,-0.2&token=undefined')
        .then(response => response.json())
            .then(data => {
                if (data.status === "ok") {
                    // Iteramos sobre cada estación
                    data.data.forEach(station => {
                        const aqi = station.aqi; // AQI de la estación
                        const latitude = station.lat; // Latitud
                        const longitude = station.lon; // Longitud
                        
                        // Crear el marcador para cada estación
                        const marker = L.marker([latitude, longitude])
                            .addTo(estacionesOficiales)
                            .bindPopup(`Estación: ${station.station.name}<br> AQI: ${aqi}`)
                            .openPopup();
                    });
                } else {
                    console.log("No se pudieron obtener los datos de las estaciones");
                }
            })
            .catch(error => console.error('Error fetching WAQI data:', error));

        // Layers control with "Capas" title and additional layers
        const additionalLayers = {
            "<span class='disabled'>Ozono O3</span>": L.layerGroup(),
            "<span class='disabled'>Monóxido de carbono CO</span>": L.layerGroup(),
            "<span class='disabled'>Dióxido de nitrógeno NO2</span>": L.layerGroup(),
        };

        // Layers control added to the map
        L.control.layers(null, { 
            "Mapa de calidad general": idwLayer,
            ...additionalLayers, 
            "Estaciones oficiales": estacionesOficiales
        }, { collapsed: false }).addTo(map);

        // Add legend
        const legend = L.control({ position: 'bottomleft' });
        legend.onAdd = function () {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <div class="legend-title">Leyenda</div>
                <div class="legend-item"><div class="color-box" style="background: green;"></div>Bueno</div>
                <div class="legend-item"><div class="color-box" style="background: yellow;"></div>Regular</div>
                <div class="legend-item"><div class="color-box" style="background: red;"></div>Malo</div>
            `;
            return div;
        };
        legend.addTo(map);

    </script>
</body>
</html>