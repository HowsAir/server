
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat"></script>
    <script src="../libs/leaflet_plugins/leaflet-idw.js"></script>
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        .leaflet-control-layers .disabled {
            pointer-events: none;
            opacity: 0.5;
        }
        .legend {
            position: absolute;
            bottom: 30px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            line-height: 1.5em;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        .legend-title {
            font-weight: bold;
        }
        .legend-item {
            display: flex;
            align-items: center;
        }
        .legend-item .color-box {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        const map = L.map('map').setView([39.4699, -0.3763], 15);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/">CARTO</a>',
            subdomains: 'abcd',
            minZoom: 14,
            maxZoom: 19
        }).addTo(map);

        const idwLayer = L.idwLayer(
            [[39.46345237249094, -0.393736556345486, 1],[39.47782768082332, -0.351695811242543, 0.6],[39.46424461187025, -0.3850223021457463, 1],[39.44805685964639, -0.3609338662621834, 1],[39.47689570889534, -0.3715718071361693, 0.6],[39.45849222285944, -0.39749827693133577, 0.6],[39.49233334679459, -0.38841420748758176, 1],[39.4524762290472, -0.3557958423487505, 1],[39.48804209539029, -0.4002414707823995, 0.3],[39.450685050619235, -0.37075456057078227, 1],[39.45870980413405, -0.3817139985228738, 0.3],[39.452594022633235, -0.38341064075676434, 1],[39.46838201425861, -0.37998833033398655, 1],[39.4565058057037, -0.3639065876577357, 1],[39.489491382919475, -0.38919579615468214, 1],[39.464758659067634, -0.3605234122205449, 0.3],[39.49382191587379, -0.38190312749353184, 1],[39.47020278185983, -0.38064076675696756, 0.6],[39.49058580231682, -0.35232731388597566, 0.6],[39.48075807582304, -0.3632564184079332, 1],[39.449347375990804, -0.3978053067092463, 1],[39.49388550059568, -0.38896106442023104, 0.6],[39.4776219688579, -0.3744567596213701, 0.3],[39.4911766140011, -0.370947908066162, 0.6],[39.482562480764365, -0.39460509855284026, 1],[39.48648078960992, -0.3633683678399989, 1],[39.48962644644083, -0.35462311663959517, 0.6],[39.473853711245205, -0.37935811120452695, 0.6],[39.48283323795977, -0.3998243567850609, 1],[39.46513602833189, -0.3573532770068972, 1],[39.49036732237641, -0.3661487360605698, 0.6],[39.45363743279361, -0.36614652240752094, 0.6],[39.47995680883095, -0.3612808617539326, 0.6],[39.45753205294619, -0.3604787666083568, 0.3],[39.4660134116181, -0.37662928636794146, 0.3],[39.475987886934874, -0.39384144258717074, 1],[39.467377735067124, -0.3965861471082176, 0.3],[39.46309307290863, -0.3679385210186566, 1],[39.478511144161864, -0.3844405855895639, 1],[39.46881684792395, -0.3583045215948527, 1],[39.47633939735348, -0.3590497334559236, 0.6],[39.46014195810889, -0.3739383570120767, 0.6],[39.453696813056006, -0.3684050363786349, 1],[39.475918318434275, -0.3962193523987778, 1],[39.44885910859855, -0.35472858443178695, 1],[39.474275129757956, -0.3749765063286896, 1],[39.47020898070115, -0.37896066826878255, 0.6],[39.48676594461946, -0.3532258053711298, 1],[39.46748527452551, -0.39056772799209377, 1],[39.47375759077419, -0.36414948953845977, 1]], // Normalizar intensidad entre 0 y 1
            {
                opacity: 0.4,          // Ajustar opacidad
                cellSize: 6,          // Tamaño de celda (ajusta según detalle)
                exp: 2,                // Exponente para ponderación (2 es estándar para IDW)
                max: 1,                // Máximo valor (intensidad normalizada)
                gradient: {            // Gradiente de colores
                    0.3: 'green',
                    0.6: 'yellow',
                    1.0: 'red'
                }
            }
        );

        map.on('zoomend', updateCellSize);

        function updateCellSize() {
            const zoom = map.getZoom();
            let newCellSize;

            if (zoom < 16) {
                newCellSize = 6;
            } else if (zoom >= 16 && zoom < 18) {
                newCellSize = 10; 
            } else if (zoom >= 18) {
                newCellSize = 25; // Ajuste de tamaño de celda a medida que el zoom es más alto
            }

            // Actualiza las opciones del layer de IDW con el nuevo tamaño de celda
            idwLayer.setOptions({ cellSize: newCellSize });
            idwLayer.redraw();
        }

        idwLayer.addTo(map);

        // Layers control with "Capas" title and additional layers
        const additionalLayers = {
            "<span class='disabled'>Ozono O3</span>": L.layerGroup(),
            "<span class='disabled'>Monóxido de carbono CO</span>": L.layerGroup(),
            "<span class='disabled'>Dióxido de nitrógeno NO2</span>": L.layerGroup(),
            "<span class='disabled'>Estaciones oficiales</span>": L.layerGroup()
        };

        // Layers control added to the map
        L.control.layers(null, { 
            "Mapa de calidad general": idwLayer,
            ...additionalLayers
        }, { collapsed: false }).addTo(map);

        // Add legend
        const legend = L.control({ position: 'bottomleft' });
        legend.onAdd = function () {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <div class="legend-title">Leyenda</div>
                <div class="legend-item"><div class="color-box" style="background: green;"></div>Bueno</div>
                <div class="legend-item"><div class="color-box" style="background: yellow;"></div>Regular</div>
                <div class="legend-item"><div class="color-box" style="background: red;"></div>Malo</div>
            `;
            return div;
        };
        legend.addTo(map);

    </script>
</body>
</html>